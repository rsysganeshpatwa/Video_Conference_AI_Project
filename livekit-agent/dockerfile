# ✅ Use NVIDIA CUDA image with cuDNN (GPU enabled)
FROM nvidia/cuda:12.1.1-cudnn8-devel-ubuntu22.04

# ✅ Set environment variables
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    DEBIAN_FRONTEND=noninteractive

# ✅ Set working directory
WORKDIR /app

# ✅ Install OS-level dependencies
RUN apt-get update && apt-get install -y \
    python3.11 \
    python3.11-dev \
    python3-pip \
    ffmpeg \
    libsm6 \
    libxext6 \
    libgl1-mesa-glx \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# ✅ Set Python 3.11 as default
RUN update-alternatives --install /usr/bin/python python /usr/bin/python3.11 1 && \
    update-alternatives --install /usr/bin/pip pip /usr/bin/pip3 1

RUN python3.11 -m pip install --upgrade pip
COPY requirements.txt .
RUN python3.11 -m pip install --no-cache-dir -r requirements.txt
RUN python3.11 -m pip install deepface tensorflow tf-keras imutils


# ✅ Copy app source code
COPY . .

# ✅ Run your app
CMD ["python", "run.py"]
